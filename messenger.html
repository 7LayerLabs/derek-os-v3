<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEREK-OS · Messenger</title>
<style>
/* ═══════════════════════════════════════════════════════════════
   DEREK-OS MESSENGER — Premium Dark Theme
   Discord meets Bloomberg Terminal
   ═══════════════════════════════════════════════════════════════ */

:root {
  --bg-primary: #0a0a0c;
  --bg-secondary: #111116;
  --bg-tertiary: #18181f;
  --bg-hover: #1e1e28;
  --bg-active: #242432;
  --border-subtle: rgba(255,255,255,0.06);
  --border-accent: rgba(255,255,255,0.1);
  --text-primary: #e8e8ed;
  --text-secondary: #8b8b9e;
  --text-muted: #55556a;
  --user-bubble: #2a2a3d;
  --agent-bubble: #151520;
  --scrollbar-track: transparent;
  --scrollbar-thumb: rgba(255,255,255,0.08);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --transition-fast: 0.15s cubic-bezier(0.4,0,0.2,1);
  --transition-med: 0.25s cubic-bezier(0.4,0,0.2,1);
  --transition-slow: 0.4s cubic-bezier(0.22,1,0.36,1);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

@font-face {
  font-family: 'SF Mono';
  src: local('SF Mono'), local('SFMono-Regular'), local('Menlo'), local('Consolas');
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  height: 100vh;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ─── SCROLLBAR ──────────────────────────────────────── */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--scrollbar-track); }
::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.14); }

/* ─── LAYOUT ─────────────────────────────────────────── */
#app {
  display: flex;
  height: 100vh;
  width: 100%;
}

/* ─── SIDEBAR ────────────────────────────────────────── */
#sidebar {
  width: 280px;
  min-width: 280px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border-subtle);
  display: flex;
  flex-direction: column;
  transition: transform var(--transition-slow), opacity var(--transition-med);
  z-index: 100;
}

#sidebar-header {
  padding: 20px 20px 12px;
  border-bottom: 1px solid var(--border-subtle);
}

#sidebar-header h1 {
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 2.5px;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 4px;
}

#sidebar-header .subtitle {
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 0.5px;
}

#connection-status {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 20px;
  font-size: 11px;
  color: var(--text-muted);
  border-bottom: 1px solid var(--border-subtle);
}

#connection-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: #3b3;
  box-shadow: 0 0 6px rgba(51,187,51,0.4);
  transition: background var(--transition-fast), box-shadow var(--transition-fast);
}

#connection-dot.offline {
  background: #c33;
  box-shadow: 0 0 6px rgba(204,51,51,0.4);
}

#agent-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.agent-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: background var(--transition-fast), transform var(--transition-fast);
  position: relative;
  user-select: none;
}

.agent-item:hover {
  background: var(--bg-hover);
}

.agent-item.active {
  background: var(--bg-active);
}

.agent-item:active {
  transform: scale(0.98);
}

.agent-avatar {
  width: 38px;
  height: 38px;
  min-width: 38px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 15px;
  color: #fff;
  position: relative;
  transition: box-shadow var(--transition-fast);
}

.agent-item.active .agent-avatar,
.agent-item:hover .agent-avatar {
  box-shadow: 0 0 0 2px var(--bg-primary), 0 0 0 3px currentColor;
}

.agent-info {
  flex: 1;
  min-width: 0;
}

.agent-name {
  font-size: 13.5px;
  font-weight: 600;
  color: var(--text-primary);
  line-height: 1.3;
}

.agent-role {
  font-size: 11px;
  color: var(--text-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.unread-badge {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #5865F2;
  color: #fff;
  font-size: 10px;
  font-weight: 700;
  display: none;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  animation: badge-pop 0.3s cubic-bezier(0.34,1.56,0.64,1);
}

.unread-badge.show {
  display: flex;
}

@keyframes badge-pop {
  0% { transform: scale(0); }
  100% { transform: scale(1); }
}

/* ─── MOBILE MENU ────────────────────────────────────── */
#mobile-toggle {
  display: none;
  position: fixed;
  top: 12px;
  left: 12px;
  z-index: 200;
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  background: var(--bg-tertiary);
  border: 1px solid var(--border-subtle);
  color: var(--text-secondary);
  font-size: 20px;
  cursor: pointer;
  align-items: center;
  justify-content: center;
  transition: background var(--transition-fast);
}

#mobile-toggle:hover { background: var(--bg-hover); }

#sidebar-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 90;
  backdrop-filter: blur(2px);
}

/* ─── CHAT PANEL ─────────────────────────────────────── */
#chat-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
  background: var(--bg-primary);
}

/* ─── CHAT HEADER ────────────────────────────────────── */
#chat-header {
  height: 60px;
  min-height: 60px;
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 0 24px;
  border-bottom: 1px solid var(--border-subtle);
  background: var(--bg-secondary);
}

#chat-header .agent-avatar {
  width: 34px;
  height: 34px;
  min-width: 34px;
  font-size: 14px;
}

#header-agent-name {
  font-size: 15px;
  font-weight: 600;
}

#header-agent-role {
  font-size: 12px;
  color: var(--text-muted);
}

#header-status {
  margin-left: auto;
  font-size: 11px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 6px;
}

#header-status .dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #3b3;
}

/* ─── EMPTY STATE ────────────────────────────────────── */
#empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  color: var(--text-muted);
}

#empty-state .logo {
  font-size: 48px;
  opacity: 0.15;
}

#empty-state .title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-secondary);
}

#empty-state .hint {
  font-size: 13px;
  color: var(--text-muted);
}

/* ─── MESSAGES ───────────────────────────────────────── */
#messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 20px 24px;
  display: none;
  flex-direction: column;
  gap: 4px;
  scroll-behavior: smooth;
}

#messages-container.visible {
  display: flex;
}

.msg-group {
  display: flex;
  flex-direction: column;
  gap: 2px;
  animation: msg-in var(--transition-slow) both;
}

@keyframes msg-in {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg-row {
  display: flex;
  align-items: flex-end;
  gap: 10px;
  max-width: 75%;
}

.msg-row.user {
  align-self: flex-end;
  flex-direction: row-reverse;
}

.msg-row.agent {
  align-self: flex-start;
}

.msg-avatar-col {
  width: 30px;
  min-width: 30px;
  display: flex;
  align-items: flex-end;
}

.msg-avatar-small {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
  color: #fff;
}

.msg-bubble {
  padding: 10px 14px;
  border-radius: var(--radius-lg);
  line-height: 1.55;
  font-size: 13.5px;
  word-wrap: break-word;
  overflow-wrap: break-word;
  position: relative;
  max-width: 100%;
}

.msg-row.user .msg-bubble {
  background: var(--user-bubble);
  border-bottom-right-radius: 4px;
  color: var(--text-primary);
}

.msg-row.agent .msg-bubble {
  background: var(--agent-bubble);
  border: 1px solid var(--border-subtle);
  border-bottom-left-radius: 4px;
  color: var(--text-primary);
}

.msg-bubble p { margin: 0 0 8px; }
.msg-bubble p:last-child { margin-bottom: 0; }
.msg-bubble code {
  font-family: 'SF Mono', 'Fira Code', Consolas, monospace;
  background: rgba(255,255,255,0.06);
  padding: 1px 5px;
  border-radius: 3px;
  font-size: 12.5px;
}
.msg-bubble pre {
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm);
  padding: 10px 12px;
  overflow-x: auto;
  margin: 8px 0;
  font-size: 12px;
  line-height: 1.5;
}
.msg-bubble pre code {
  background: none;
  padding: 0;
}
.msg-bubble strong { color: #fff; font-weight: 600; }
.msg-bubble em { color: var(--text-secondary); }
.msg-bubble ul, .msg-bubble ol { padding-left: 20px; margin: 6px 0; }
.msg-bubble li { margin: 2px 0; }
.msg-bubble a { color: #7aa2f7; text-decoration: none; }
.msg-bubble a:hover { text-decoration: underline; }
.msg-bubble blockquote {
  border-left: 3px solid var(--border-accent);
  padding-left: 12px;
  margin: 8px 0;
  color: var(--text-secondary);
}

.msg-time {
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 3px;
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.msg-row:hover .msg-time {
  opacity: 1;
}

.msg-row.user .msg-time {
  text-align: right;
  padding-right: 40px;
}

.msg-row.agent .msg-time {
  padding-left: 40px;
}

/* ─── TYPING INDICATOR ───────────────────────────────── */
#typing-indicator {
  display: none;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  animation: msg-in var(--transition-slow) both;
}

#typing-indicator.show {
  display: flex;
}

.typing-dots {
  display: flex;
  gap: 4px;
  padding: 12px 16px;
  background: var(--agent-bubble);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  border-bottom-left-radius: 4px;
}

.typing-dots span {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--text-muted);
  animation: typing-bounce 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(2) { animation-delay: 0.16s; }
.typing-dots span:nth-child(3) { animation-delay: 0.32s; }

@keyframes typing-bounce {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-5px); opacity: 1; }
}

/* ─── INPUT AREA ─────────────────────────────────────── */
#input-area {
  padding: 16px 24px 20px;
  border-top: 1px solid var(--border-subtle);
  background: var(--bg-secondary);
  display: none;
}

#input-area.visible {
  display: block;
}

#input-wrapper {
  display: flex;
  align-items: flex-end;
  gap: 10px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  padding: 6px 6px 6px 16px;
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

#input-wrapper:focus-within {
  border-color: rgba(255,255,255,0.15);
  box-shadow: 0 0 0 3px rgba(88,101,242,0.12);
}

#msg-input {
  flex: 1;
  background: none;
  border: none;
  outline: none;
  color: var(--text-primary);
  font-size: 14px;
  font-family: inherit;
  resize: none;
  max-height: 120px;
  min-height: 24px;
  line-height: 1.5;
  padding: 6px 0;
}

#msg-input::placeholder {
  color: var(--text-muted);
}

#send-btn {
  width: 36px;
  height: 36px;
  min-width: 36px;
  border-radius: 10px;
  background: #5865F2;
  border: none;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background var(--transition-fast), transform var(--transition-fast), opacity var(--transition-fast);
}

#send-btn:hover { background: #4752c4; }
#send-btn:active { transform: scale(0.92); }
#send-btn:disabled { opacity: 0.35; cursor: not-allowed; }

#send-btn svg {
  width: 18px;
  height: 18px;
}

/* ─── MOBILE RESPONSIVE ──────────────────────────────── */
@media (max-width: 768px) {
  #sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    transform: translateX(-100%);
    box-shadow: var(--shadow-lg);
  }

  #sidebar.open {
    transform: translateX(0);
  }

  #sidebar-overlay.show {
    display: block;
  }

  #mobile-toggle {
    display: flex;
  }

  #chat-header {
    padding-left: 60px;
  }

  .msg-row {
    max-width: 88%;
  }

  #messages-container {
    padding: 16px;
  }

  #input-area {
    padding: 12px 16px 16px;
  }
}

@media (max-width: 480px) {
  #sidebar { width: 260px; min-width: 260px; }
  .msg-row { max-width: 92%; }
}

/* ─── STREAMED TEXT CURSOR ───────────────────────────── */
.streaming-cursor::after {
  content: '▊';
  animation: cursor-blink 0.8s step-end infinite;
  color: var(--text-muted);
  margin-left: 1px;
}

@keyframes cursor-blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}

/* ─── CLEAR CHAT BTN ─────────────────────────────────── */
#clear-chat {
  background: none;
  border: 1px solid var(--border-subtle);
  color: var(--text-muted);
  font-size: 11px;
  padding: 4px 10px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  margin-left: 12px;
  transition: all var(--transition-fast);
}

#clear-chat:hover {
  border-color: #c33;
  color: #f66;
  background: rgba(204,51,51,0.08);
}
</style>
</head>
<body>

<!-- ═══════════════ MOBILE TOGGLE ═══════════════ -->
<button id="mobile-toggle" onclick="toggleSidebar()">☰</button>
<div id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="app">
  <!-- ═══════════════ SIDEBAR ═══════════════ -->
  <aside id="sidebar">
    <div id="sidebar-header">
      <h1>DEREK-OS</h1>
      <div class="subtitle">Agent Messenger</div>
    </div>
    <div id="connection-status">
      <div id="connection-dot"></div>
      <span id="connection-text">Connected</span>
    </div>
    <div id="agent-list"></div>
  </aside>

  <!-- ═══════════════ CHAT PANEL ═══════════════ -->
  <main id="chat-panel">
    <!-- Header -->
    <div id="chat-header" style="display:none">
      <div class="agent-avatar" id="header-avatar"></div>
      <div>
        <div id="header-agent-name"></div>
        <div id="header-agent-role"></div>
      </div>
      <div id="header-status">
        <div class="dot"></div>
        <span>Online</span>
        <button id="clear-chat" onclick="clearChat()">Clear</button>
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state">
      <div class="logo">⌘</div>
      <div class="title">DEREK-OS Messenger</div>
      <div class="hint">Select an agent from the sidebar to begin</div>
    </div>

    <!-- Messages -->
    <div id="messages-container"></div>

    <!-- Typing Indicator -->
    <div id="typing-indicator">
      <div style="width:30px;min-width:30px"></div>
      <div class="typing-dots">
        <span></span><span></span><span></span>
      </div>
    </div>

    <!-- Input -->
    <div id="input-area">
      <div id="input-wrapper">
        <textarea id="msg-input" rows="1" placeholder="Message agent…" onkeydown="handleKey(event)" oninput="autoGrow(this)"></textarea>
        <button id="send-btn" onclick="sendMessage()" title="Send">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </main>
</div>

<script>
/* ═══════════════════════════════════════════════════════════════
   CONFIGURATION — Change these to update API endpoint/token
   ═══════════════════════════════════════════════════════════════ */
const CONFIG = {
  API_URL: 'https://above-patrick-external-chance.trycloudflare.com/v1/responses',
  TOKEN: 'd99386fc7415bcfb9020de68e8d9c09b81c531a3b1deda9e',
  USER_PREFIX: 'derek-webchat-',
  STORAGE_KEY: 'derek-os-messenger',
};

/* ═══════════════════════════════════════════════════════════════
   AGENTS
   ═══════════════════════════════════════════════════════════════ */
const AGENTS = [
  { id: 'milo',   name: 'Milo',   role: 'Chief of Staff',       color: '#D4A017', initial: 'M'  },
  { id: 'bobby',  name: 'Bobby',  role: 'Trading Advisor',      color: '#2ea043', initial: 'B'  },
  { id: 'wendy',  name: 'Wendy',  role: 'Performance Coach',    color: '#9B59B6', initial: 'W'  },
  { id: 'paula',  name: 'Paula',  role: 'Creative Director',    color: '#E84393', initial: 'P'  },
  { id: 'anders', name: 'Anders', role: 'Full Stack Architect', color: '#3B82F6', initial: 'A'  },
  { id: 'tony',   name: 'Tony',   role: 'Restaurant Ops',       color: '#E67E22', initial: 'T'  },
  { id: 'remy',   name: 'Remy',   role: 'Restaurant Marketing', color: '#E74C3C', initial: 'R'  },
  { id: 'dwight', name: 'Dwight', role: 'Weather & News',       color: '#8B6914', initial: 'D'  },
  { id: 'dax',    name: 'Dax',    role: 'Data Analyst',         color: '#14B8A6', initial: 'X'  },
];

/* ═══════════════════════════════════════════════════════════════
   STATE
   ═══════════════════════════════════════════════════════════════ */
let activeAgentId = null;
let isStreaming = false;
let abortController = null;
let chatHistory = {}; // { agentId: [ {role, text, time} ] }
let unreadCounts = {}; // { agentId: number }

// Load persisted history
try {
  const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
  if (saved) chatHistory = JSON.parse(saved);
} catch(e) { chatHistory = {}; }

function saveHistory() {
  try { localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(chatHistory)); } catch(e) {}
}

/* ═══════════════════════════════════════════════════════════════
   RENDER SIDEBAR
   ═══════════════════════════════════════════════════════════════ */
function renderAgentList() {
  const list = document.getElementById('agent-list');
  list.innerHTML = '';
  AGENTS.forEach(a => {
    const el = document.createElement('div');
    el.className = 'agent-item' + (a.id === activeAgentId ? ' active' : '');
    el.onclick = () => selectAgent(a.id);
    el.id = 'agent-item-' + a.id;

    const count = unreadCounts[a.id] || 0;
    el.innerHTML = `
      <div class="agent-avatar" style="background:${a.color};color:#fff">${a.initial}</div>
      <div class="agent-info">
        <div class="agent-name">${a.name}</div>
        <div class="agent-role">${a.role}</div>
      </div>
      <div class="unread-badge ${count > 0 ? 'show' : ''}" id="badge-${a.id}">${count}</div>
    `;
    list.appendChild(el);
  });
}

/* ═══════════════════════════════════════════════════════════════
   SELECT AGENT
   ═══════════════════════════════════════════════════════════════ */
function selectAgent(agentId) {
  if (isStreaming && agentId !== activeAgentId) return; // prevent switch mid-stream

  activeAgentId = agentId;
  const agent = AGENTS.find(a => a.id === agentId);
  if (!agent) return;

  // Clear unread
  unreadCounts[agentId] = 0;

  // Update sidebar
  renderAgentList();

  // Update header
  const header = document.getElementById('chat-header');
  header.style.display = 'flex';
  document.getElementById('header-avatar').style.background = agent.color;
  document.getElementById('header-avatar').textContent = agent.initial;
  document.getElementById('header-agent-name').textContent = agent.name;
  document.getElementById('header-agent-role').textContent = agent.role;

  // Show chat area
  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('messages-container').classList.add('visible');
  document.getElementById('input-area').classList.add('visible');

  // Render messages
  renderMessages();
  scrollToBottom(true);

  // Focus input
  document.getElementById('msg-input').focus();

  // Close mobile sidebar
  if (window.innerWidth <= 768) toggleSidebar(false);
}

/* ═══════════════════════════════════════════════════════════════
   RENDER MESSAGES
   ═══════════════════════════════════════════════════════════════ */
function renderMessages() {
  const container = document.getElementById('messages-container');
  container.innerHTML = '';
  const msgs = chatHistory[activeAgentId] || [];
  const agent = AGENTS.find(a => a.id === activeAgentId);

  msgs.forEach((msg, i) => {
    const row = createMessageRow(msg, agent);
    container.appendChild(row);
  });
}

function createMessageRow(msg, agent) {
  const group = document.createElement('div');
  group.className = 'msg-group';

  const row = document.createElement('div');
  row.className = 'msg-row ' + msg.role;

  if (msg.role === 'agent') {
    const avatarCol = document.createElement('div');
    avatarCol.className = 'msg-avatar-col';
    const avatar = document.createElement('div');
    avatar.className = 'msg-avatar-small';
    avatar.style.background = agent.color;
    avatar.textContent = agent.initial;
    avatarCol.appendChild(avatar);
    row.appendChild(avatarCol);
  }

  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  bubble.innerHTML = renderMarkdown(msg.text);
  row.appendChild(bubble);

  group.appendChild(row);

  const timeEl = document.createElement('div');
  timeEl.className = 'msg-time';
  timeEl.textContent = formatTime(msg.time);
  if (msg.role === 'user') timeEl.style.textAlign = 'right';
  else timeEl.style.paddingLeft = '40px';
  group.appendChild(timeEl);

  return group;
}

/* ═══════════════════════════════════════════════════════════════
   MARKDOWN RENDERER (lightweight)
   ═══════════════════════════════════════════════════════════════ */
function renderMarkdown(text) {
  if (!text) return '';
  let html = escapeHtml(text);

  // Code blocks
  html = html.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
    return `<pre><code>${code.trim()}</code></pre>`;
  });

  // Inline code
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

  // Bold
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

  // Italic
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

  // Links
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');

  // Blockquotes
  html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');

  // Unordered lists
  html = html.replace(/^[-*] (.+)$/gm, '<li>$1</li>');
  html = html.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');

  // Headers
  html = html.replace(/^### (.+)$/gm, '<strong style="font-size:14px">$1</strong>');
  html = html.replace(/^## (.+)$/gm, '<strong style="font-size:15px">$1</strong>');
  html = html.replace(/^# (.+)$/gm, '<strong style="font-size:16px">$1</strong>');

  // Paragraphs (double newline)
  html = html.replace(/\n\n/g, '</p><p>');
  html = '<p>' + html + '</p>';
  html = html.replace(/<p><\/p>/g, '');

  // Single newlines → <br>
  html = html.replace(/\n/g, '<br>');

  return html;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/* ═══════════════════════════════════════════════════════════════
   SEND MESSAGE
   ═══════════════════════════════════════════════════════════════ */
async function sendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text || isStreaming || !activeAgentId) return;

  // Add user message
  if (!chatHistory[activeAgentId]) chatHistory[activeAgentId] = [];
  chatHistory[activeAgentId].push({ role: 'user', text, time: Date.now() });
  saveHistory();
  renderMessages();
  scrollToBottom();

  // Clear input
  input.value = '';
  input.style.height = 'auto';

  // Start streaming
  isStreaming = true;
  setInputEnabled(false);
  showTyping(true);

  const agent = AGENTS.find(a => a.id === activeAgentId);

  try {
    abortController = new AbortController();

    const response = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + CONFIG.TOKEN,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'clawdbot:' + activeAgentId,
        input: text,
        stream: true,
        user: CONFIG.USER_PREFIX + activeAgentId,
      }),
      signal: abortController.signal,
    });

    if (!response.ok) {
      throw new Error(`API error: ${response.status}`);
    }

    // Set online
    setConnectionStatus(true);

    // Create agent message entry
    const agentMsg = { role: 'agent', text: '', time: Date.now() };
    chatHistory[activeAgentId].push(agentMsg);
    const msgIndex = chatHistory[activeAgentId].length - 1;

    showTyping(false);

    // Append streaming message to DOM
    const container = document.getElementById('messages-container');
    const group = document.createElement('div');
    group.className = 'msg-group';

    const row = document.createElement('div');
    row.className = 'msg-row agent';

    const avatarCol = document.createElement('div');
    avatarCol.className = 'msg-avatar-col';
    const avatar = document.createElement('div');
    avatar.className = 'msg-avatar-small';
    avatar.style.background = agent.color;
    avatar.textContent = agent.initial;
    avatarCol.appendChild(avatar);
    row.appendChild(avatarCol);

    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble streaming-cursor';
    row.appendChild(bubble);
    group.appendChild(row);

    const timeEl = document.createElement('div');
    timeEl.className = 'msg-time';
    timeEl.style.paddingLeft = '40px';
    timeEl.textContent = formatTime(Date.now());
    group.appendChild(timeEl);

    container.appendChild(group);
    scrollToBottom();

    // Read SSE stream
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let fullText = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      for (const line of lines) {
        if (line.startsWith('event: ')) {
          const eventType = line.slice(7).trim();
          continue;
        }

        if (line.startsWith('data: ')) {
          const dataStr = line.slice(6);
          if (dataStr === '[DONE]') continue;

          try {
            const data = JSON.parse(dataStr);

            // Handle delta text
            if (data.delta) {
              fullText += data.delta;
              bubble.innerHTML = renderMarkdown(fullText);
              scrollToBottom();
            }

            // Handle completed
            if (data.type === 'response.completed' || data.type === 'response.done') {
              // Final
            }
          } catch(e) {
            // Non-JSON data line, skip
          }
        }
      }
    }

    // Finalize
    bubble.classList.remove('streaming-cursor');
    agentMsg.text = fullText;
    agentMsg.time = Date.now();
    saveHistory();

  } catch (err) {
    showTyping(false);
    if (err.name === 'AbortError') {
      // User cancelled
    } else {
      // Show error
      setConnectionStatus(false);
      if (!chatHistory[activeAgentId]) chatHistory[activeAgentId] = [];
      chatHistory[activeAgentId].push({
        role: 'agent',
        text: `⚠️ **Agent offline** — Could not reach ${agent.name}. Error: ${err.message}`,
        time: Date.now(),
      });
      saveHistory();
      renderMessages();
      scrollToBottom();
    }
  } finally {
    isStreaming = false;
    abortController = null;
    setInputEnabled(true);
    document.getElementById('msg-input').focus();
  }
}

/* ═══════════════════════════════════════════════════════════════
   UTILITIES
   ═══════════════════════════════════════════════════════════════ */
function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoGrow(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function setInputEnabled(enabled) {
  document.getElementById('msg-input').disabled = !enabled;
  document.getElementById('send-btn').disabled = !enabled;
  document.getElementById('msg-input').placeholder = enabled
    ? 'Message agent…'
    : 'Waiting for response…';
}

function showTyping(show) {
  document.getElementById('typing-indicator').classList.toggle('show', show);
  if (show) scrollToBottom();
}

function scrollToBottom(instant) {
  const container = document.getElementById('messages-container');
  requestAnimationFrame(() => {
    container.scrollTo({
      top: container.scrollHeight,
      behavior: instant ? 'auto' : 'smooth'
    });
  });
}

function formatTime(ts) {
  const d = new Date(ts);
  const h = d.getHours();
  const m = d.getMinutes().toString().padStart(2, '0');
  const ampm = h >= 12 ? 'PM' : 'AM';
  const hr = h % 12 || 12;
  return `${hr}:${m} ${ampm}`;
}

function setConnectionStatus(online) {
  const dot = document.getElementById('connection-dot');
  const text = document.getElementById('connection-text');
  dot.classList.toggle('offline', !online);
  text.textContent = online ? 'Connected' : 'Offline';
}

function clearChat() {
  if (!activeAgentId) return;
  if (!confirm('Clear chat history with this agent?')) return;
  chatHistory[activeAgentId] = [];
  saveHistory();
  renderMessages();
}

function toggleSidebar(forceState) {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  const isOpen = sidebar.classList.contains('open');
  const shouldOpen = forceState !== undefined ? forceState : !isOpen;

  sidebar.classList.toggle('open', shouldOpen);
  overlay.classList.toggle('show', shouldOpen);
}

/* ═══════════════════════════════════════════════════════════════
   INIT
   ═══════════════════════════════════════════════════════════════ */
renderAgentList();

// Connection check
async function checkConnection() {
  try {
    const r = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + CONFIG.TOKEN,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ model: 'clawdbot:milo', input: 'ping', stream: false, user: 'derek-webchat-healthcheck' }),
      signal: AbortSignal.timeout(8000)
    });
    setConnectionStatus(r.ok);
  } catch(e) {
    setConnectionStatus(false);
  }
}
// Initial check after short delay
setTimeout(checkConnection, 2000);
// Periodic check every 60s
setInterval(checkConnection, 60000);

// Keyboard shortcut: Escape to close sidebar on mobile
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    if (isStreaming && abortController) {
      abortController.abort();
    }
    if (window.innerWidth <= 768) toggleSidebar(false);
  }
});
</script>
</body>
</html>
